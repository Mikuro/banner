#!/bin/bash

# –¢–µ—Å—Ç API –Ω–∞ VPS
API_URL="http://45.8.228.89:8080"

echo "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º API –Ω–∞ ${API_URL}"

# 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏
echo "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ API..."
curl -f ${API_URL}/ && echo " ‚úÖ API —Ä–∞–±–æ—Ç–∞–µ—Ç" || echo " ‚ùå API –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç"

# 2. –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–∑–∞–º–µ–Ω–∏ test.jpg –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª)
if [[ -f "test.jpg" ]]; then
    echo "2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ..."
    RESPONSE=$(curl -s -X POST -F 'image=@test.jpg' ${API_URL}/upload)
    echo "–û—Ç–≤–µ—Ç: $RESPONSE"

    # –ò–∑–≤–ª–µ–∫–∞–µ–º imageId –∏–∑ –æ—Ç–≤–µ—Ç–∞
    IMAGE_ID=$(echo $RESPONSE | grep -o '"imageId":"[^"]*' | cut -d'"' -f4)

    if [[ -n "$IMAGE_ID" ]]; then
        echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: $IMAGE_ID"

        # 3. –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        echo "3. –ü–æ–ª—É—á–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ..."
        curl -s ${API_URL}/link/${IMAGE_ID} | jq .

        # 4. –ü–æ–ª—É—á–∞–µ–º HTML —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
        echo "4. –ü–æ–ª—É—á–∞–µ–º HTML..."
        curl -s ${API_URL}/html-link/${IMAGE_ID} | jq -r '.html' | base64 -d > result.html
        echo "HTML —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ result.html"

        echo "üåê –ü—Ä–µ–≤—å—é: ${API_URL}/preview/${IMAGE_ID}"
    else
        echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
    fi
else
    echo "‚ö†Ô∏è  –î–ª—è —Ç–µ—Å—Ç–∞ —Å–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª test.jpg"
fi
